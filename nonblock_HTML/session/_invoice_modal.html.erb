<%# Invoice Builder Modal - expects locals/state: invoice_state, rows, tech_rates, summary %>
<style>
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 9998; }
  .modal { position: fixed; inset: 5% 5%; background: #111; color: #eee; border: 1px solid #333; border-radius: 6px; display: flex; flex-direction: column; z-index: 9999; }
  .modal-header { padding: 8px 12px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
  .modal-body { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; padding: 8px; overflow: hidden; height: calc(100% - 100px); }
  .modal-footer { padding: 8px 12px; border-top: 1px solid #333; display: flex; gap: 8px; justify-content: flex-end; }
  .toolbar { display: flex; gap: 8px; align-items: center; }
  .toolbar input[type="date"], .toolbar select { background: #000; color: #eee; border: 1px solid #333; border-radius: 4px; padding: 4px 6px; }
  .list-panel { overflow: auto; border-right: 1px solid #333; padding-right: 6px; }
  .summary-panel { overflow: auto; padding-left: 6px; }
  .row { display: grid; grid-template-columns: 24px 110px 1fr 140px 90px; gap: 6px; padding: 6px 4px; border-bottom: 1px dashed #222; align-items: center; }
  .row.header { font-weight: bold; position: sticky; top: 0; background: #0d0d0d; z-index: 1; }
  .checkbox { width: 18px; height: 18px; }
  .rate-input { width: 90px; background: #000; color: #eee; border: 1px solid #333; border-radius: 4px; padding: 2px 4px; }
  .btn { background: #1b72e8; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
  .btn.secondary { background: #333; }
  .pill { display: inline-block; padding: 2px 6px; border-radius: 999px; background: #222; border: 1px solid #333; margin-left: 6px; font-size: 12px; }
  .json-output { width: 100%; height: 120px; background: #000; color: #0f0; border: 1px solid #333; border-radius: 4px; font-family: monospace; padding: 6px; }
</style>

<div id="invoice_modal_backdrop" class="modal-backdrop" ws-send hx-vals='{"cat":"quickbooks_time","act":"close_invoice"}' hx-trigger="click"></div>
<div id="invoice_modal" class="modal">
  <div class="modal-header">
    <div>
      <strong>Invoice Builder</strong>
      <span class="pill"><%= invoice_state[:jobsite_name] || 'Jobsite' %></span>
      <span class="pill"><%= rows.length %> entries</span>
    </div>
    <div class="toolbar">
      <label>From <input type="date" value="<%= invoice_state[:from_date] %>"
        ws-send hx-vals='{"cat":"quickbooks_time","act":"set_date","which":"from","val":"__VAL__"}'
        oninput="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.value))" /></label>
      <label>To <input type="date" value="<%= invoice_state[:to_date] %>"
        ws-send hx-vals='{"cat":"quickbooks_time","act":"set_date","which":"to","val":"__VAL__"}'
        oninput="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.value))" /></label>
      <label>Sort
        <select ws-send hx-vals='{"cat":"quickbooks_time","act":"set_sort","val":"__VAL__"}'
          onchange="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.value))">
          <option value="date" <%= 'selected' if invoice_state[:sort] == 'date' %>>Date</option>
          <option value="tech" <%= 'selected' if invoice_state[:sort] == 'tech' %>>Technician</option>
          <option value="duration" <%= 'selected' if invoice_state[:sort] == 'duration' %>>Duration</option>
        </select>
      </label>
      <label>Group
        <select ws-send hx-vals='{"cat":"quickbooks_time","act":"set_group","val":"__VAL__"}'
          onchange="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.value))">
          <option value="tech" <%= 'selected' if invoice_state[:group] == 'tech' %>>By Technician</option>
          <option value="day" <%= 'selected' if invoice_state[:group] == 'day' %>>By Day</option>
          <option value="week" <%= 'selected' if invoice_state[:group] == 'week' %>>By Week</option>
        </select>
      </label>
    </div>
  </div>

  <div class="modal-body">
    <div class="list-panel">
      <div class="row header">
        <div></div>
        <div>Date</div>
        <div>Technician / Notes</div>
        <div>Time</div>
        <div>Hours</div>
      </div>
      <% last_group = nil %>
      <% rows.each do |r| %>
        <%
          tsid = r['id']
          selected = invoice_state[:selected_ids].include?(tsid)
          start_s = r['start_time'] || r['start']
          end_s   = r['end_time'] || r['end']
          dur     = (r['duration_seconds'] || r['duration'] || 0).to_i
          hours   = (dur / 3600.0)
          date_s  = r['date']
          group_val = case invoice_state[:group]
                      when 'tech' then (r['user_name'] || ("User "+(r['user_id']||'').to_s))
                      when 'week'
                        begin
                          d = Date.parse(date_s)
                          "Week "+d.cweek.to_s+" "+d.year.to_s
                        rescue StandardError
                          date_s
                        end
                      else
                        date_s
                      end
        %>
        <% if group_val && group_val != last_group %>
          <div class="row header" style="grid-template-columns: 1fr;">
            <div><%= group_val %></div>
          </div>
          <% last_group = group_val %>
        <% end %>
        <div class="row">
          <input class="checkbox" type="checkbox" <%= 'checked' if selected %>
            ws-send hx-vals='{"cat":"quickbooks_time","act":"toggle_ts","id":"<%= tsid %>","checked":"__VAL__"}'
            onchange="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.checked))" />
          <div><%= date_s %></div>
          <div>
            <div><%= r['user_name'] || ("User "+(r['user_id']||'').to_s) %></div>
            <% if (r['notes'] && !r['notes'].strip.empty?) %>
              <div class="text-xsmall" style="opacity:0.8; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;">
                <%= r['notes'] %>
              </div>
            <% end %>
          </div>
          <div><%= [start_s, end_s].compact.join(' â†’ ') %></div>
          <div><%= sprintf('%.2f', hours) %></div>
        </div>
      <% end %>
    </div>

    <div class="summary-panel">
      <div class="row header" style="grid-template-columns: 1fr 100px 110px;">
        <div>Technician</div>
        <div>Hours</div>
        <div>Rate</div>
      </div>
      <% summary[:by_tech].each do |user_id, info| %>
        <div class="row" style="grid-template-columns: 1fr 100px 110px;">
          <div><%= info[:name] %></div>
          <div><%= sprintf('%.2f', info[:hours]) %></div>
          <div>
            <input class="rate-input" type="number" step="0.01" min="0"
              value="<%= tech_rates[user_id] || 0 %>"
              ws-send hx-vals='{"cat":"quickbooks_time","act":"set_rate","user_id":"<%= user_id %>","val":"__VAL__"}'
              oninput="this.setAttribute('hx-vals', this.getAttribute('hx-vals').replace('__VAL__', this.value))" />
          </div>
        </div>
      <% end %>

      <div class="row" style="grid-template-columns: 1fr 100px 110px; border-top: 1px solid #333;">
        <div><strong>Total</strong></div>
        <div><strong><%= sprintf('%.2f', summary[:total_hours]) %> h</strong></div>
        <div></div>
      </div>

      <div class="row" style="grid-template-columns: 1fr 100px 110px;">
        <div><strong>Estimated</strong></div>
        <div></div>
        <div><strong>$<%= sprintf('%.2f', summary[:estimated_total]) %></strong></div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn secondary" ws-send hx-vals='{"cat":"quickbooks_time","act":"close_invoice"}'>Close</button>
    <button class="btn" ws-send hx-vals='{"cat":"quickbooks_time","act":"export_json"}'>Export JSON</button>
  </div>

  <% if invoice_state[:json_output] %>
    <div style="padding: 8px 12px;">
      <textarea class="json-output" readonly id="invoice_json"><%= invoice_state[:json_output] %></textarea>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn secondary" onclick="const t=document.getElementById('invoice_json'); t.select(); document.execCommand('copy');">Copy</button>
        <span style="opacity:0.8;">JSON ready for QBO mapping</span>
      </div>
    </div>
  <% end %>
</div>
